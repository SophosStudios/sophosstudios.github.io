<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Chat - SophosWRLD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="./config.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease-in-out, background-image 0.3s ease-in-out;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #a78bfa; /* Default purple */
            background-image: linear-gradient(to right, #60a5fa, #a78bfa); /* Default gradient */
        }
        .chat-container {
            height: 80vh; /* Responsive height */
            max-height: 700px;
            display: flex;
            flex-direction: column;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        /* Custom scrollbar for Webkit browsers */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: #e2e8f0; /* bg-gray-200 */
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #9ca3af; /* bg-gray-400 */
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
    </style>
</head>
<body class="min-h-screen font-inter bg-gradient-to-r from-blue-400 to-purple-600">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 z-50 hidden">
        <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-white"></div>
    </div>

    <!-- Message Modal (Re-usable and matching App.js structure) -->
    <div id="message-modal" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 z-50 p-4 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center max-w-sm w-full">
            <p id="modal-message-content" class="text-xl mb-6 text-gray-800"></p>
            <div id="modal-buttons" class="flex justify-center space-x-4">
                <button id="modal-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full transition duration-300 transform hover:scale-105">OK</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full transition duration-300 transform hover:scale-105 hidden">Confirm</button>
                <button id="modal-cancel-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full transition duration-300 transform hover:scale-105 hidden">Cancel</button>
            </div>
        </div>
    </div>

    <div class="flex flex-col md:flex-row items-start justify-center p-4 w-full h-full min-h-screen gap-4">
        <!-- Main Chat Area -->
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl backdrop-blur-sm bg-opacity-80 border border-gray-200 chat-container">
            <h2 id="room-title" class="text-3xl font-extrabold text-center text-gray-800 mb-6">Loading Room...</h2>
            <div id="chat-messages" class="chat-messages bg-gray-100 p-4 rounded-lg mb-4 space-y-3">
                <!-- Chat messages will be loaded here -->
            </div>
            <form id="chat-form" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <textarea id="message-input" rows="1" class="flex-grow resize-none px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700" placeholder="Type your message..." required></textarea>
                <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full transition duration-300 transform hover:scale-105 shadow-lg">
                    Send
                </button>
            </form>
            <div class="mt-4 text-center">
                <button id="back-to-admin-btn" class="py-2 px-4 rounded-full bg-gray-500 text-white font-bold text-sm hover:bg-gray-600 transition duration-300 transform hover:scale-105 shadow-lg">
                    Back to Admin Panel
                </button>
            </div>
        </div>

        <!-- Active Users Panel -->
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs backdrop-blur-sm bg-opacity-80 border border-gray-200 h-fit md:h-[80vh]">
            <h3 class="text-2xl font-extrabold text-center text-gray-800 mb-4">Active Users</h3>
            <div id="active-users-list" class="space-y-2 overflow-y-auto max-h-[calc(80vh-100px)]">
                <!-- Active users will be listed here -->
                <p class="text-gray-500 text-center text-sm">Loading active users...</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // Global variables for Firebase and user data
        let app, auth, db;
        let currentUser = null;
        let userData = null;
        let APP_ID = '';
        let roomId = null;
        let roomTitle = '';
        let currentModal = null; // To manage active message modal
        let presenceInterval = null; // Interval for presence updates

        // --- Utility Functions (Duplicated from App.js for standalone page) ---

        /**
         * Shows a loading spinner.
         */
        function showLoadingSpinner() {
            let spinner = document.getElementById('loading-spinner');
            if (!spinner) {
                spinner = document.createElement('div');
                spinner.id = 'loading-spinner';
                spinner.className = 'fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 z-50';
                spinner.innerHTML = `<div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-white"></div>`;
                document.body.appendChild(spinner);
            }
            spinner.classList.remove('hidden'); // Ensure it's visible
        }

        /**
         * Hides the loading spinner.
         */
        function hideLoadingSpinner() {
            const spinner = document.getElementById('loading-spinner');
            if (spinner) {
                spinner.classList.add('hidden'); // Hide it
            }
        }

        /**
         * Displays a message modal.
         * @param {string} message - The message to display.
         * @param {string} type - 'info', 'error', or 'confirm'.
         * @param {function} onConfirm - Callback for 'confirm' type (only for 'confirm' type).
         */
        function showMessageModal(message, type = 'info', onConfirm = null) {
            if (currentModal && !currentModal.classList.contains('hidden')) {
                // If a modal is already open, close it before opening a new one
                currentModal.classList.add('hidden');
            }

            const modal = document.getElementById('message-modal');
            const modalMessage = document.getElementById('modal-message-content');
            const modalOkBtn = document.getElementById('modal-ok-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');

            modalMessage.textContent = message;
            modalMessage.className = `text-xl mb-6 ${type === 'error' ? 'text-red-600' : 'text-gray-800'}`;

            // Reset button visibility
            modalOkBtn.classList.add('hidden');
            modalConfirmBtn.classList.add('hidden');
            modalCancelBtn.classList.add('hidden');

            if (type === 'confirm') {
                modalConfirmBtn.classList.remove('hidden');
                modalCancelBtn.classList.remove('hidden');
            } else {
                modalOkBtn.classList.remove('hidden');
            }

            modal.classList.remove('hidden');
            currentModal = modal; // Set the current modal reference

            const closeModal = () => {
                if (currentModal) {
                    currentModal.classList.add('hidden');
                    currentModal = null;
                }
            };

            modalOkBtn.onclick = closeModal;
            modalCancelBtn.onclick = closeModal;
            modalConfirmBtn.onclick = () => {
                closeModal();
                if (onConfirm) onConfirm();
            };
        }


        /**
         * Updates the body's background. Reads from localStorage or uses default.
         */
        function updateBodyBackground() {
            document.body.className = '';
            document.body.style.backgroundImage = '';
            document.body.style.backgroundSize = '';
            document.body.style.backgroundPosition = '';
            document.body.style.backgroundRepeat = '';
            document.body.style.backgroundAttachment = '';

            let backgroundUrl = localStorage.getItem('userBackgroundUrl');
            if (backgroundUrl) {
                if (backgroundUrl.startsWith('http://') || backgroundUrl.startsWith('https://')) {
                    document.body.style.backgroundImage = `url('${backgroundUrl}')`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    document.body.style.backgroundRepeat = 'no-repeat';
                    document.body.style.backgroundAttachment = 'fixed';
                } else {
                    document.body.classList.add(...backgroundUrl.split(' '));
                }
            } else {
                document.body.classList.add('bg-gradient-to-r', 'from-blue-400', 'to-purple-600');
            }
            document.body.classList.add('min-h-screen', 'font-inter');
        }

        // --- Core Chat Functionality ---

        /**
         * Initializes Firebase and checks authentication status.
         */
        async function initializeFirebaseAndAuth() {
            showLoadingSpinner();
            try {
                let firebaseConfig;
                let appId;
                let initialAuthToken;

                // Prioritize global variables from Canvas runtime if available
                if (typeof __firebase_config !== 'undefined' && typeof __app_id !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                    appId = __app_id;
                    initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    console.log("Firebase config loaded from global Canvas variables.");
                } else {
                    // Fallback to localStorage if not running in Canvas or globals not present
                    const configString = localStorage.getItem('firebaseConfig');
                    const appIdString = localStorage.getItem('APP_ID');
                    initialAuthToken = localStorage.getItem('__initial_auth_token');

                    if (!configString || !appIdString) {
                        throw new Error("Firebase configuration or App ID not found. Please log in through the main application.");
                    }
                    firebaseConfig = JSON.parse(configString);
                    appId = appIdString;
                    console.log("Firebase config loaded from localStorage.");
                }

                APP_ID = appId; // Set global APP_ID

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Use the custom auth token if available, otherwise sign in anonymously
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } catch (error) {
                        console.warn("Custom token sign-in failed, trying anonymous:", error);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        // Attempt to load user data from localStorage first
                        let userDataString = localStorage.getItem('userData');
                        if (userDataString) {
                            userData = JSON.parse(userDataString);
                            console.log("User data loaded from localStorage:", userData);
                            updateBodyBackground(); // Apply user's background
                        } else {
                            // If not in localStorage, fetch from Firestore (should be rare if App.js works correctly)
                            const userDocRef = doc(db, `/artifacts/${APP_ID}/public/data/users`, currentUser.uid);
                            const docSnap = await getDoc(userDocRef);
                            if (docSnap.exists()) {
                                userData = docSnap.data();
                                localStorage.setItem('userData', JSON.stringify(userData)); // Save to localStorage
                                updateBodyBackground(); // Apply user's background
                            } else {
                                showMessageModal("User profile not found. Please log in again.", 'error', () => {
                                    signOut(auth); // Sign out if profile not found
                                    window.location.href = 'index.html'; // Go back to home
                                });
                                hideLoadingSpinner();
                                return;
                            }
                        }
                        loadRoomDetailsAndMessages(); // Proceed to load chat
                        setupPresence(); // Start presence tracking
                    } else {
                        // User is logged out or session expired
                        currentUser = null;
                        userData = null;
                        showMessageModal("You must be logged in to access chat rooms. Redirecting to login.", 'info', () => {
                            window.location.href = 'index.html#auth'; // Redirect to auth page
                        });
                        hideLoadingSpinner();
                        // Clear any ongoing presence updates if logged out
                        if (presenceInterval) clearInterval(presenceInterval);
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or auth error:", error);
                showMessageModal("Failed to initialize chat: " + error.message, 'error', () => {
                    window.location.href = 'index.html'; // Go back to home on critical error
                });
                hideLoadingSpinner();
            }
        }

        /**
         * Fetches room details and sets up real-time listener for messages.
         */
        async function loadRoomDetailsAndMessages() {
            const urlParams = new URLSearchParams(window.location.search);
            roomId = urlParams.get('id');
            roomTitle = urlParams.get('title') || 'Unknown Room';

            if (!roomId) {
                showMessageModal("No room ID provided. Returning to admin panel.", 'error', () => {
                    window.location.href = 'index.html#admin';
                });
                return;
            }

            document.getElementById('room-title').textContent = `Chat in "${decodeURIComponent(roomTitle)}"`;

            const messagesRef = collection(db, `/artifacts/${APP_ID}/public/data/rooms/${roomId}/messages`);
            const q = query(messagesRef, orderBy('timestamp', 'asc'));

            onSnapshot(q, async (snapshot) => {
                const chatMessagesDiv = document.getElementById('chat-messages');
                chatMessagesDiv.innerHTML = ''; // Clear existing messages

                // Fetch all user profiles for message display
                const usersCollectionRef = collection(db, `/artifacts/${APP_ID}/public/data/users`);
                const usersSnapshot = await getDocs(usersCollectionRef); // Fetch all user docs once
                const usersMap = {};
                usersSnapshot.forEach(doc => {
                    usersMap[doc.id] = doc.data();
                });

                snapshot.forEach((msgDoc) => {
                    const msg = msgDoc.data();
                    const senderData = usersMap[msg.authorId] || { username: 'Unknown User', profilePicUrl: '' };
                    const profilePic = senderData.profilePicUrl || `https://placehold.co/40x40/F0F0F0/000000?text=${(senderData.username || 'U').charAt(0).toUpperCase()}`;

                    const messageElement = document.createElement('div');
                    messageElement.className = `
                        flex items-start gap-3 p-3 rounded-lg shadow-sm w-full
                        ${msg.authorId === currentUser.uid ? 'bg-blue-200 self-end ml-auto flex-row-reverse' : 'bg-gray-200 self-start mr-auto'}
                    `;
                    messageElement.innerHTML = `
                        <img src="${profilePic}" alt="Avatar" class="w-10 h-10 rounded-full object-cover border-2 border-gray-300 flex-shrink-0" onerror="this.onerror=null; this.src='https://placehold.co/40x40/F0F0F0/000000?text=${(senderData.username || 'U').charAt(0).toUpperCase()}'">
                        <div class="flex flex-col ${msg.authorId === currentUser.uid ? 'items-end' : 'items-start'} flex-grow">
                            <p class="font-semibold text-sm ${msg.authorId === currentUser.uid ? 'text-blue-800' : 'text-gray-800'}">${msg.authorUsername}</p>
                            <p class="text-gray-700 break-words">${msg.text}</p>
                            <p class="text-xs text-gray-500 mt-1">${new Date(msg.timestamp.toDate()).toLocaleString()}</p>
                        </div>
                    `;
                    chatMessagesDiv.appendChild(messageElement);
                });
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
            }, (error) => {
                console.error("Error fetching messages:", error);
                showMessageModal("Failed to load chat messages: " + error.message, 'error');
            });
        }

        /**
         * Sends a new chat message to Firestore.
         * @param {string} messageText - The content of the message.
         */
        async function sendMessage(messageText) {
            if (!currentUser || !userData || !roomId) {
                showMessageModal("You must be logged in and in a room to send messages.", 'info');
                return;
            }
            if (!messageText.trim()) {
                showMessageModal("Message cannot be empty.", 'info');
                return;
            }

            try {
                const messagesCollectionRef = collection(db, `/artifacts/${APP_ID}/public/data/rooms/${roomId}/messages`);
                await addDoc(messagesCollectionRef, {
                    text: messageText,
                    authorId: currentUser.uid,
                    authorUsername: userData.username || currentUser.displayName || currentUser.email,
                    profilePicUrl: userData.profilePicUrl || '', // Store sender's profile picture URL
                    timestamp: serverTimestamp()
                });
                document.getElementById('message-input').value = ''; // Clear input
            } catch (error) {
                console.error("Error sending message:", error);
                showMessageModal("Failed to send message: " + error.message, 'error');
            }
        }

        /**
         * Sets up real-time presence tracking for the current user in the room.
         */
        async function setupPresence() {
            if (!currentUser || !roomId) return;

            const presenceRef = doc(db, `/artifacts/${APP_ID}/public/data/rooms/${roomId}/presence`, currentUser.uid);

            // Update presence immediately and then every few seconds
            const updateMyPresence = async () => {
                await setDoc(presenceRef, {
                    userId: currentUser.uid,
                    username: userData.username || currentUser.displayName || currentUser.email,
                    profilePicUrl: userData.profilePicUrl || '',
                    lastSeen: serverTimestamp(),
                }, { merge: true }); // Use merge to avoid overwriting other fields if added later
            };

            // Initial update
            updateMyPresence();

            // Set up interval for periodic updates (e.g., every 5 seconds)
            presenceInterval = setInterval(updateMyPresence, 5000);

            // Listen for other users' presence
            const presenceCollectionRef = collection(db, `/artifacts/${APP_ID}/public/data/rooms/${roomId}/presence`);
            // Query for users seen within the last 15 seconds (3 * 5 second intervals + buffer)
            const activeThreshold = new Date(Date.now() - 15 * 1000);
            const q = query(presenceCollectionRef, orderBy('lastSeen', 'desc'));

            onSnapshot(q, (snapshot) => {
                const activeUsersListDiv = document.getElementById('active-users-list');
                activeUsersListDiv.innerHTML = '';
                let activeUsersCount = 0;

                snapshot.forEach((userDoc) => {
                    const presenceData = userDoc.data();
                    // Filter out users not seen recently
                    if (presenceData.lastSeen && presenceData.lastSeen.toDate() > activeThreshold) {
                        activeUsersCount++;
                        const userElement = document.createElement('div');
                        userElement.className = 'flex items-center space-x-3 p-2 bg-gray-100 rounded-md shadow-sm';
                        const userProfilePic = presenceData.profilePicUrl || `https://placehold.co/30x30/F0F0F0/000000?text=${(presenceData.username || 'U').charAt(0).toUpperCase()}`;

                        userElement.innerHTML = `
                            <img src="${userProfilePic}" alt="User Avatar" class="w-8 h-8 rounded-full object-cover border-2 border-green-500">
                            <span class="font-semibold text-gray-800">${presenceData.username}</span>
                            ${presenceData.userId === currentUser.uid ? '<span class="text-xs text-blue-500">(You)</span>' : ''}
                        `;
                        activeUsersListDiv.appendChild(userElement);
                    }
                });

                if (activeUsersCount === 0) {
                    activeUsersListDiv.innerHTML = '<p class="text-gray-500 text-center text-sm">No one else is online.</p>';
                }
            }, (error) => {
                console.error("Error fetching active users:", error);
                activeUsersListDiv.innerHTML = '<p class="text-red-500 text-center text-sm">Error loading active users.</p>';
            });

            // Clean up presence when user leaves the page
            // This is a best-effort approach as 'beforeunload' is not guaranteed for all scenarios
            window.addEventListener('beforeunload', async () => {
                if (currentUser && roomId) {
                    // Update lastSeen one final time (or remove document)
                    // Removing might be too aggressive if user just refreshes or navigates quickly
                    // For a more robust solution, Firestore's server-side timestamps and TTL might be better
                    // but that requires Firebase Functions. For client-side, updating lastSeen is safer.
                    await setDoc(presenceRef, { lastSeen: serverTimestamp() }, { merge: true });
                }
                if (presenceInterval) clearInterval(presenceInterval);
            });
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebaseAndAuth();

            document.getElementById('chat-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const messageInput = document.getElementById('message-input');
                sendMessage(messageInput.value);
            });

            document.getElementById('back-to-admin-btn').addEventListener('click', () => {
                window.location.href = 'index.html#admin';
            });
        });
    </script>
</body>
</html>
