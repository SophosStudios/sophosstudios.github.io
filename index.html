<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SophosWRLD â€” Allâ€‘inâ€‘One SPA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --accent:#ef4444; --bg:#0b0d12; --bg-elev:#0f1117; --fg:#e5e7eb; --muted:#9ca3af }
    .card{ background:var(--bg-elev); border:1px solid rgba(255,255,255,.06); border-radius:1rem; }
    .btn{ padding:.6rem 1rem; border-radius:1rem; font-weight:600; border:1px solid rgba(255,255,255,.1); background:#121623; color:#fff }
    .btn-primary{ background:var(--accent); border-color:transparent }
    .input{ height:40px; border-radius:.6rem; background:#0f1117; border:1px solid rgba(255,255,255,.1); padding:0 .75rem; color:#e5e7eb }
    .navtab{ padding:.5rem .75rem; border-radius:.75rem; font-weight:600; font-size:.9rem }
    .navtab.active{ background:rgba(255,255,255,.06) }
    .truncate-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
  </style>
  <!-- Firebase (Compat) â€” paste your own config below -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>
</head>
<body class="bg-[#0b0d12] text-gray-100 min-h-svh">
  <div id="app" class="min-h-svh grid md:grid-cols-[280px_1fr] gap-3 p-3">
    <!-- Sidebar -->
    <aside class="card p-3 md:p-4 flex flex-col gap-3">
      <div class="flex items-center gap-3">
        <img id="sidebarAvatar" src="assets/avatar.png" class="w-12 h-12 rounded-full object-cover ring-2 ring-red-500" alt="avatar" />
        <div class="min-w-0">
          <div class="font-semibold truncate" id="sidebarName">Guest</div>
          <div class="text-sm text-gray-400 truncate" id="sidebarBio">Signed out</div>
        </div>
      </div>

      <div class="flex items-center justify-between text-sm">
        <span class="text-gray-400">Currency</span>
        <span id="sidebarCurrency" class="font-semibold">0</span>
      </div>

      <nav id="sidebarNav" class="grid gap-1">
        <button class="navtab active" data-route="/home">Home</button>
        <button class="navtab" data-route="/chat">Chat</button>
        <button class="navtab" data-route="/forums">Forums</button>
        <button class="navtab" data-route="/profile">My Profile</button>
        <button class="navtab" data-route="/settings">Settings</button>
        <button class="navtab hidden" id="adminNav" data-route="/admin">Admin</button>
      </nav>

      <div>
        <label class="text-sm text-gray-400 block mb-1">Accent</label>
        <input id="accentInput" type="color" value="#ef4444" class="w-full h-10 rounded border border-white/10 bg-[#0f1117]" />
      </div>

      <div>
        <label class="text-sm text-gray-400 block mb-1">Redeem Code</label>
        <div class="flex gap-2">
          <input id="redeemCodeInput" class="flex-1 input" placeholder="ENTER-CODE"/>
          <button id="redeemBtn" class="btn btn-primary">Redeem</button>
        </div>
        <div id="redeemMsg" class="text-xs text-gray-400 mt-1"></div>
      </div>

      <div id="adminPanelMini" class="hidden mt-3 border-t border-white/10 pt-3">
        <div class="text-sm font-semibold mb-2">Quick Admin</div>
        <input id="adminUid" class="w-full input mb-2" placeholder="Target UID"/>
        <div class="flex gap-2">
          <input id="adminAmount" type="number" class="flex-1 input" placeholder="+/- amount"/>
          <button id="adminAdjustBtn" class="btn btn-primary">Apply</button>
        </div>
        <div class="text-xs text-gray-400 mt-1">Currency adjust for a user.</div>
      </div>
    </aside>

    <!-- Main -->
    <main class="grid grid-rows-[auto_1fr] gap-3">
      <div class="card p-3 md:p-4 flex items-center justify-between">
        <div class="font-semibold" id="routeTitle">Home</div>
        <div class="text-sm text-gray-400" id="statusText">Not signed in</div>
      </div>

      <div class="grid gap-3" id="routes">
        <!-- HOME -->
        <section data-view="/home" class="card p-3 md:p-4">
          <div class="grid lg:grid-cols-3 gap-3">
            <div class="card p-4">
              <div class="text-sm text-gray-400 mb-2">Latest Threads</div>
              <div id="homeLatestThreads" class="flex flex-col gap-2"></div>
            </div>
            <div class="card p-4">
              <div class="text-sm text-gray-400 mb-2">Online Users</div>
              <div id="homeOnlineUsers" class="flex flex-col gap-2"></div>
            </div>
            <div class="card p-4">
              <div class="text-sm text-gray-400 mb-2">Quick Post</div>
              <div class="grid gap-2">
                <input id="quickTitle" class="input" placeholder="Title"/>
                <textarea id="quickBody" class="input h-24" placeholder="Say somethingâ€¦"></textarea>
                <select id="quickCategory" class="input"></select>
                <button id="quickPostBtn" class="btn btn-primary">Create Thread</button>
                <div id="quickMsg" class="text-xs text-gray-400"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- CHAT -->
        <section data-view="/chat" class="grid lg:grid-cols-[340px_1fr] gap-3 hidden">
          <div class="card p-3 md:p-4">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm text-gray-400">Users</div>
              <input id="userSearch" placeholder="Search" class="input w-40"/>
            </div>
            <div id="usersList" class="flex flex-col gap-2 max-h-[60svh] overflow-y-auto pr-1"></div>
          </div>
          <div class="card p-3 md:p-4 flex flex-col">
            <div class="text-sm text-gray-400">Open a user to chat or call.</div>
            <div class="mt-auto flex gap-2">
              <input id="chatInput" class="flex-1 h-12 rounded bg-[#0f1117] border border-white/10 px-3" placeholder="Messageâ€¦"/>
              <button id="sendBtn" class="btn btn-primary">Send</button>
            </div>
          </div>
        </section>

        <!-- FORUMS -->
        <section data-view="/forums" class="grid lg:grid-cols-[280px_1fr] gap-3 hidden">
          <div class="card p-3 md:p-4">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm text-gray-400">Categories</div>
              <button id="newCategoryBtn" class="btn hidden">New</button>
            </div>
            <div id="catList" class="flex flex-col gap-1"></div>
          </div>
          <div class="grid gap-3">
            <div class="card p-3 md:p-4">
              <div class="flex items-center justify-between">
                <div class="text-sm text-gray-400" id="threadsHeader">Threads</div>
                <button id="newThreadBtn" class="btn btn-primary">New Thread</button>
              </div>
              <div id="threadsList" class="mt-2 flex flex-col"></div>
            </div>
            <div class="card p-3 md:p-4 hidden" id="threadView">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-semibold" id="threadTitle">â€”</div>
                  <div class="text-xs text-gray-400" id="threadMeta">â€”</div>
                </div>
                <div class="flex gap-2">
                  <button id="threadEditBtn" class="btn hidden">Edit</button>
                  <button id="threadDeleteBtn" class="btn hidden">Delete</button>
                </div>
              </div>
              <div id="postsList" class="mt-3 flex flex-col gap-3"></div>
              <div id="replyBox" class="mt-3 grid gap-2">
                <textarea id="replyInput" class="input h-24" placeholder="Write a replyâ€¦"></textarea>
                <button id="replySendBtn" class="btn btn-primary">Reply</button>
              </div>
            </div>
          </div>
        </section>

        <!-- PROFILE -->
        <section data-view="/profile" class="card p-3 md:p-4 hidden">
          <div class="flex items-center gap-4">
            <img id="profileAvatarDisplay" src="assets/avatar.png" class="w-24 h-24 rounded-full object-cover ring-2 ring-red-500" alt="avatar"/>
            <div>
              <div class="text-xl font-semibold" id="profileNameDisplay">Guest</div>
              <div class="text-sm text-gray-400" id="profileBioDisplay">â€”</div>
              <div class="text-xs text-gray-500">UID: <span id="profileUid">â€”</span></div>
            </div>
          </div>
          <div class="mt-4">
            <div class="text-sm text-gray-400 mb-1">My Recent Threads</div>
            <div id="myThreads" class="flex flex-col"></div>
          </div>
          <div class="mt-4">
            <button id="openProfileBtn" class="btn">Edit Profile</button>
          </div>
        </section>

        <!-- SETTINGS -->
        <section data-view="/settings" class="card p-3 md:p-4 hidden">
          <div class="grid sm:grid-cols-2 gap-4">
            <div class="grid gap-2">
              <div class="font-semibold">Appearance</div>
              <div class="flex items-center gap-3">
                <label class="text-sm text-gray-400">Accent</label>
                <input id="profileAccent" type="color" value="#ef4444" class="h-10 w-14 rounded border border-white/10 bg-[#0f1117]" />
              </div>
            </div>
            <div class="grid gap-2">
              <div class="font-semibold">Privacy</div>
              <label class="text-sm flex items-center gap-2">
                <input type="checkbox" id="hideEmail"/> Hide my email
              </label>
              <label class="text-sm flex items-center gap-2">
                <input type="checkbox" id="hideOnline"/> Hide online status
              </label>
              <button id="saveSettingsBtn" class="btn btn-primary mt-2">Save Settings</button>
              <div id="settingsMsg" class="text-xs text-gray-400"></div>
            </div>
          </div>
        </section>

        <!-- ADMIN -->
        <section data-view="/admin" class="grid lg:grid-cols-2 gap-3 hidden">
          <div class="card p-3 md:p-4">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm text-gray-400">Users</div>
              <div class="flex gap-2">
                <input id="adminSearch" class="input w-40" placeholder="Search users"/>
                <button id="refreshUsersBtn" class="btn">Refresh</button>
              </div>
            </div>
            <div id="adminUsers" class="flex flex-col max-h-[60svh] overflow-y-auto"></div>
          </div>
          <div class="card p-3 md:p-4">
            <div class="text-sm text-gray-400 mb-2">Moderation</div>
            <div id="moderationBox" class="text-sm text-gray-300">Select a post/thread to moderate from Forums.</div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Profile Edit Sheet -->
  <div id="profileSheet" class="fixed inset-x-0 bottom-0 z-40 hidden">
    <div class="card rounded-t-2xl p-4 bg-[#0f1117]">
      <div class="flex justify-between items-center mb-3">
        <div class="font-semibold">Profile Settings</div>
        <button id="profileClose" class="btn">Close</button>
      </div>
      <div class="grid sm:grid-cols-2 gap-4">
        <div class="flex items-center gap-3">
          <img id="profileAvatarPreview" src="assets/avatar.png" class="w-16 h-16 rounded-full object-cover ring-2 ring-red-500" alt="avatar"/>
          <div>
            <input id="profileAvatarFile" type="file" accept="image/*" class="block text-sm" />
            <div class="text-xs text-gray-400">Upload a square image</div>
          </div>
        </div>
        <div class="grid gap-2">
          <input id="profileName" class="input" placeholder="Username"/>
          <input id="profileBio" class="input" placeholder="Bio / status message"/>
          <button id="saveProfileBtn" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== Firebase Setup (paste your config) ======
    const firebaseConfig = {
      // apiKey: "YOUR_API_KEY",
      // authDomain: "YOUR_PROJECT.firebaseapp.com",
      // projectId: "YOUR_PROJECT_ID",
      // storageBucket: "YOUR_PROJECT.appspot.com",
      // messagingSenderId: "YOUR_SENDER_ID",
      // appId: "YOUR_APP_ID"
    };

    let app, auth, db, storage;
    document.addEventListener("DOMContentLoaded", () => {
      if (Object.keys(firebaseConfig).length) {
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        storage = firebase.storage();
        setStatus("Firebase ready");
      } else {
        setStatus("Demo mode");
      }
      initRouter();
      seedDemo();
    });

    // ====== Utils & State ======
    const $ = (id) => document.getElementById(id);
    function setStatus(t){ $("statusText").textContent = t; }
    function setAccent(hex){ document.documentElement.style.setProperty("--accent", hex); }
    function timeAgo(ts){
      if (!ts) return "just now";
      const d = ts instanceof Date ? ts : new Date(ts);
      const diff = (Date.now() - d.getTime())/1000;
      if (diff < 60) return Math.floor(diff)+"s ago";
      if (diff < 3600) return Math.floor(diff/60)+"m ago";
      if (diff < 86400) return Math.floor(diff/3600)+"h ago";
      return d.toLocaleString();
    }
    function escapeHTML(s=''){ return s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[c])); }

    const state = {
      user: { uid: "demo", name: "Guest", bio: "", avatar: "assets/avatar.png", role: "member", currency: 0, accentColor: "#ef4444" },
      categories: [], threads: [], posts: {}, // posts[threadId] = array
      users: []
    };

    // ====== Router ======
    const routes = {
      "/home": () => { showView("/home"); $("routeTitle").textContent = "Home"; renderHome(); },
      "/chat": () => { showView("/chat"); $("routeTitle").textContent = "Chat"; renderUsers(state.users); },
      "/forums": () => { showView("/forums"); $("routeTitle").textContent = "Forums"; renderCategories(); renderThreads(); },
      "/thread": (params) => { showView("/forums"); $("routeTitle").textContent = "Forums"; openThread(params.id); },
      "/profile": () => { showView("/profile"); $("routeTitle").textContent = "Profile"; renderProfile(); },
      "/settings": () => { showView("/settings"); $("routeTitle").textContent = "Settings"; },
      "/admin": () => { showView("/admin"); $("routeTitle").textContent = "Admin"; renderAdminUsers(); }
    };
    function parseHash(){
      const h = location.hash.replace('#','') || '/home';
      const [path] = h.split('?');
      const parts = path.split('/').filter(Boolean);
      if (parts[0] === 'thread' && parts[1]) return { route: '/thread', params: { id: parts[1] } };
      const route = '/' + (parts[0] || 'home');
      return { route, params: {} };
    }
    function navigate(path){ location.hash = path; }
    function handleRoute(){
      const { route, params } = parseHash();
      document.querySelectorAll('#sidebarNav .navtab').forEach(b => b.classList.toggle('active', b.dataset.route === route));
      (routes[route] || routes['/home'])(params);
    }
    function showView(view){
      document.querySelectorAll('[data-view]').forEach(sec => sec.classList.toggle('hidden', sec.getAttribute('data-view') !== view));
      $("threadView").classList.add("hidden");
    }
    function initRouter(){
      document.querySelectorAll('#sidebarNav [data-route]').forEach(btn => btn.addEventListener('click', () => navigate(btn.dataset.route)));
      window.addEventListener('hashchange', handleRoute);
      handleRoute();
    }

    // ====== Demo seed (no Firebase required) ======
    function seedDemo(){
      state.users = [
        { uid:"u1", name:"Alice", bio:"Builder", avatar:"assets/avatar.png" },
        { uid:"u2", name:"Bob", bio:"Moderator", avatar:"assets/avatar.png" },
        { uid:"u3", name:"Charlie", bio:"Hacker", avatar:"assets/avatar.png" }
      ];
      state.categories = [
        { id:"c1", name:"General", description:"Talk about anything", order:1 },
        { id:"c2", name:"Help", description:"Ask for help", order:2 },
        { id:"c3", name:"Showcase", description:"Share your work", order:3 }
      ];
      state.threads = [
        { id:"t1", categoryId:"c1", categoryName:"General", title:"Welcome to SophosWRLD", body:"Say hi!", authorId:"u1", authorName:"Alice", createdAt:new Date(Date.now()-3600_000), lastPostAt:new Date(), replyCount:2, pinned:true },
        { id:"t2", categoryId:"c2", categoryName:"Help", title:"How do I change my accent color?", body:"Where is the setting?", authorId:"u2", authorName:"Bob", createdAt:new Date(Date.now()-86_400_000), lastPostAt:new Date(Date.now()-10_000), replyCount:1, pinned:false }
      ];
      state.posts["t1"] = [
        { id:"p1", authorId:"u2", authorName:"Bob", authorAvatar:"assets/avatar.png", body:"Hello!", createdAt:new Date(Date.now()-1800_000) },
        { id:"p2", authorId:"u3", authorName:"Charlie", authorAvatar:"assets/avatar.png", body:"Yo!", createdAt:new Date(Date.now()-1200_000) }
      ];
      state.posts["t2"] = [
        { id:"p3", authorId:"u1", authorName:"Alice", authorAvatar:"assets/avatar.png", body:"Settings > Appearance", createdAt:new Date(Date.now()-9_000) }
      ];
      renderHome();
      renderCategories();
      renderThreads();
      renderUsers(state.users);
      renderProfile();
    }

    // ====== Home ======
    function renderHome(){
      const latestBox = $("homeLatestThreads"); latestBox.innerHTML = "";
      state.threads.slice(0,6).forEach(t => {
        const row = document.createElement('button');
        row.className = "w-full text-left p-2 rounded hover:bg-white/5";
        row.innerHTML = `<div class="font-medium truncate">${t.pinned ? 'ðŸ“Œ ' : ''}${escapeHTML(t.title)}</div>
                         <div class="text-xs text-gray-400">in ${escapeHTML(t.categoryName)} â€¢ by ${escapeHTML(t.authorName)} â€¢ ${timeAgo(t.createdAt)}</div>`;
        row.onclick = () => location.hash = `/thread/${t.id}`;
        latestBox.appendChild(row);
      });
      const onlineBox = $("homeOnlineUsers"); onlineBox.innerHTML = "";
      state.users.forEach(u => {
        const div = document.createElement('div');
        div.className = "flex items-center gap-3 p-2 rounded hover:bg-white/5";
        div.innerHTML = `<img src="${u.avatar}" class="w-8 h-8 rounded-full"/>
                         <div class="min-w-0"><div class="font-medium truncate">${escapeHTML(u.name)}</div>
                         <div class="text-xs text-gray-400">active ${Math.floor(Math.random()*10)+1}m ago</div></div>`;
        onlineBox.appendChild(div);
      });
      const sel = $("quickCategory"); sel.innerHTML = "";
      state.categories.forEach(c => { const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; sel.appendChild(o); });
      $("quickPostBtn").onclick = () => {
        const title = $("quickTitle").value.trim().slice(0,120);
        const body = $("quickBody").value.trim();
        const catId = $("quickCategory").value;
        if (!title || !body || !catId) { $("quickMsg").textContent = "Please fill all fields."; return; }
        const cat = state.categories.find(c=>c.id===catId);
        const id = "t"+(Date.now());
        const t = { id, categoryId:catId, categoryName:cat.name, title, body, authorId:"demo", authorName:state.user.name, createdAt:new Date(), lastPostAt:new Date(), replyCount:0, pinned:false };
        state.threads.unshift(t);
        $("quickTitle").value=""; $("quickBody").value=""; $("quickMsg").textContent="Thread created!";
        location.hash = `/thread/${id}`;
      };
    }

    // ====== Users (Chat) ======
    function renderUsers(list){
      const box = $("usersList"); box.innerHTML = "";
      list.forEach(u => {
        const li = document.createElement('div');
        li.className = "flex items-center justify-between gap-2 p-2 rounded hover:bg-white/5";
        li.innerHTML = `
          <div class="flex items-center gap-3 min-w-0">
            <img src="${u.avatar}" class="w-10 h-10 rounded-full" />
            <div class="min-w-0">
              <div class="font-medium truncate">${escapeHTML(u.name)}</div>
              <div class="text-xs text-gray-400 truncate-2">${escapeHTML(u.bio||"")}</div>
            </div>
          </div>
          <div class="flex gap-2 shrink-0">
            <button class="btn" title="Message">Msg</button>
            <button class="btn btn-primary" title="Call">Call</button>
          </div>`;
        li.querySelectorAll("button")[0].onclick = () => { $("chatInput").value = `@${u.name} `; $("chatInput").focus(); };
        li.querySelectorAll("button")[1].onclick = () => alert("Calling (demo) "+u.name+"â€¦");
        box.appendChild(li);
      });
      $("userSearch").oninput = (e) => {
        const q = e.target.value.toLowerCase();
        const filtered = state.users.filter(u => (u.name||"").toLowerCase().includes(q));
        renderUsers(filtered);
      };
      $("sendBtn").onclick = () => { const v=$("chatInput").value.trim(); if(!v) return; alert("Message (demo): "+v); $("chatInput").value=""; };
    }

    // ====== Forums ======
    let currentCategoryId = null;
    function renderCategories(){
      const box = $("catList"); box.innerHTML = "";
      state.categories.forEach(c => {
        const b = document.createElement('button');
        b.className = "w-full text-left px-3 py-2 rounded hover:bg-white/5";
        b.innerHTML = `<div class="font-medium">${escapeHTML(c.name)}</div><div class="text-xs text-gray-400">${escapeHTML(c.description||"")}</div>`;
        b.onclick = () => { currentCategoryId=c.id; renderThreads(); };
        box.appendChild(b);
        if (!currentCategoryId) currentCategoryId = c.id;
      });
    }
    function renderThreads(){
      const list = $("threadsList"); list.innerHTML = "";
      state.threads.filter(t=>t.categoryId===currentCategoryId).forEach(t => {
        const row = document.createElement('div');
        row.className = "flex items-center justify-between p-2 rounded hover:bg-white/5";
        row.innerHTML = `<div class="min-w-0">
            <div class="font-medium truncate">${t.pinned ? 'ðŸ“Œ ' : ''}${escapeHTML(t.title)}</div>
            <div class="text-xs text-gray-400">by ${escapeHTML(t.authorName)} â€¢ ${t.replyCount||0} replies â€¢ ${timeAgo(t.lastPostAt)}</div>
          </div>
          <button class="btn" title="Open">Open</button>`;
        row.querySelector('button').onclick = () => location.hash = `/thread/${t.id}`;
        list.appendChild(row);
      });
      $("newThreadBtn").onclick = () => {
        const title = prompt("Thread title"); if (!title) return;
        const body = prompt("Body"); if (!body) return;
        const cat = state.categories.find(c=>c.id===currentCategoryId);
        const id = "t"+Date.now();
        const t = { id, categoryId:cat.id, categoryName:cat.name, title:title.trim().slice(0,120), body:body.trim(), authorId:"demo", authorName:state.user.name, createdAt:new Date(), lastPostAt:new Date(), replyCount:0, pinned:false };
        state.threads.unshift(t);
        location.hash = `/thread/${id}`;
      };
    }
    function openThread(threadId){
      const t = state.threads.find(x=>x.id===threadId); if(!t){ alert("Thread not found"); return; }
      $("threadView").classList.remove("hidden");
      $("threadTitle").textContent = t.title;
      $("threadMeta").textContent = `${t.categoryName} â€¢ by ${t.authorName} â€¢ ${timeAgo(t.createdAt)}`;
      const list = $("postsList"); list.innerHTML = "";
      const first = document.createElement('div');
      first.className = "p-3 rounded bg-white/5";
      first.innerHTML = `<div class="font-medium">${escapeHTML(t.authorName)}</div>
                         <div class="text-xs text-gray-400">${timeAgo(t.createdAt)}</div>
                         <div class="mt-2 whitespace-pre-wrap">${escapeHTML(t.body)}</div>`;
      list.appendChild(first);
      const replies = state.posts[threadId] || [];
      replies.forEach(p => {
        const row = document.createElement('div');
        row.className = "p-3 rounded bg-white/[.03] border border-white/5";
        row.innerHTML = `<div class="font-medium">${escapeHTML(p.authorName)}</div>
                         <div class="text-xs text-gray-400">${timeAgo(p.createdAt)}</div>
                         <div class="mt-2 whitespace-pre-wrap">${escapeHTML(p.body||"")}</div>`;
        list.appendChild(row);
      });
      $("replySendBtn").onclick = () => {
        const body = $("replyInput").value.trim(); if(!body) return;
        const p = { id:"p"+Date.now(), authorId:"demo", authorName:state.user.name, authorAvatar:state.user.avatar, body, createdAt:new Date() };
        if (!state.posts[threadId]) state.posts[threadId]=[];
        state.posts[threadId].push(p);
        t.replyCount = (t.replyCount||0)+1;
        t.lastPostAt = new Date();
        $("replyInput").value = "";
        openThread(threadId);
      };
    }

    // ====== Profile ======
    $("openProfileBtn").onclick = () => $("profileSheet").classList.remove("hidden");
    $("profileClose").onclick = () => $("profileSheet").classList.add("hidden");
    $("saveProfileBtn").onclick = () => {
      state.user.name = $("profileName").value.trim() || state.user.name;
      state.user.bio  = $("profileBio").value.trim() || state.user.bio;
      $("profileSheet").classList.add("hidden");
      renderProfile();
    };
    $("accentInput").oninput = (e) => { setAccent(e.target.value); };
    $("profileAccent").oninput = (e) => { setAccent(e.target.value); };

    function renderProfile(){
      $("sidebarName").textContent = state.user.name;
      $("sidebarBio").textContent = state.user.bio || "";
      $("profileNameDisplay").textContent = state.user.name;
      $("profileBioDisplay").textContent = state.user.bio || "â€”";
      $("profileUid").textContent = state.user.uid;
      $("profileName").value = state.user.name;
      $("profileBio").value = state.user.bio;
    }

    // ====== Admin (demo) ======
    function renderAdminUsers(){
      const box = $("adminUsers"); box.innerHTML = "";
      state.users.forEach(u => {
        const row = document.createElement('div');
        row.className = "flex items-center justify-between p-2 rounded hover:bg-white/5";
        row.innerHTML = `<div class="min-w-0"><div class="font-medium truncate">${escapeHTML(u.name)}</div><div class="text-xs text-gray-400 truncate">${u.uid}</div></div>
                         <div class="flex gap-2"><select class="input w-28"><option>member</option><option>moderator</option><option>admin</option></select>
                         <button class="btn">Ban</button></div>`;
        box.appendChild(row);
      });
      $("refreshUsersBtn").onclick = renderAdminUsers;
      $("adminSearch").oninput = (e) => {
        const q = e.target.value.toLowerCase();
        Array.from(box.children).forEach(div => {
          const text = div.textContent.toLowerCase();
          div.style.display = text.includes(q) ? "" : "none";
        });
      };
    }
  </script>
</body>
</html>
