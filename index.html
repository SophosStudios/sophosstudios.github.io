<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SophosWRLD — Developer Hub</title>
  <style>
    :root{
      --bg:#121212;
      --panel:#1e1e1e;
      --panel-2:#161616;
      --text:#e5e5e5;
      --muted:#a7a7a7;
      --accent:#e53935;
      --accent-2:#ff6b6b;
      --border:#2a2a2a;
      --ok:#2e7d32;
      --warn:#f9a825;
    }
    *{box-sizing:border-box}
    html, body { height:100%; }
    body { margin:0; background:var(--bg); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    a{ color: var(--accent-2); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* Top Nav */
    .topbar{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(180deg, #151515, #111);
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:10px;
      padding:10px 16px;
    }
    .brand{ font-weight:700; letter-spacing:.3px; }
    .brand .dot{ color:var(--accent); }
    .tabs{ display:flex; gap:8px; margin-left:12px; flex-wrap:wrap; }
    .tab{
      border:1px solid var(--border); background:var(--panel); color:var(--text);
      padding:8px 12px; border-radius:10px; cursor:pointer;
      transition:.2s transform, .2s background, .2s border-color;
    }
    .tab:hover{ transform:translateY(-1px); border-color:#3a3a3a; }
    .tab.active{ background: #1a1a1a; border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent) inset; }
    .grow{ flex:1; }
    .signout{ border:1px solid var(--border); background:#1a1a1a; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .google{ display:flex; align-items:center; gap:8px; border:1px solid var(--border); background:#fff; color:#111; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;}
    .google img{ width:18px; height:18px; }

    /* Containers */
    .wrap{ max-width:1100px; margin: 18px auto; padding: 0 16px; }
    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; }
    .card{
      background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h3{ margin:0 0 8px 0; }
    .muted{ color:var(--muted); }

    /* Auth */
    .auth { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .auth .panel{ width:100%; max-width:860px; }
    .auth .grid > .col{ grid-column: span 6; }
    .field{ display:flex; flex-direction:column; gap:6px; margin:8px 0; }
    .field input{
      background:var(--panel-2); border:1px solid var(--border); color:#fff; padding:10px 12px; border-radius:10px;
      outline:none;
    }
    .btn{ background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.secondary{ background:transparent; border:1px solid var(--border); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .center{ text-align:center; }
    .hidden{ display:none !important; }

    /* Sections */
    .section{ display:none; }
    .section.active{ display:block; }

    /* Forum styles */
    .thread{ border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:10px; background:#181818; }
    .thread .title{ font-weight:700; }
    .thread .meta{ color:var(--muted); font-size:12px; }
    .post{ padding:10px; border-left:3px solid var(--accent); background:#141414; margin:8px 0; border-radius:8px; }
    .composer textarea{
      width:100%; min-height:90px; background:#141414; color:#fff; border:1px solid var(--border); border-radius:10px; padding:10px;
    }

    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; background:#221; border:1px solid var(--border); color:#f5b3b2; font-size:12px; }

    /* Hero */
    .hero{
      display:grid; grid-template-columns: 1.4fr .6fr; gap:16px; align-items:center;
    }
    .hero img{ width:100%; border-radius:16px; border:1px solid var(--border); background:#0c0c0c; }

    /* Responsive */
    @media (max-width: 900px){
      .hero{ grid-template-columns: 1fr; }
      .auth .grid > .col{ grid-column: span 12; }
    }
  </style>
</head>
<body>

<!-- AUTH SCREENS -->
<div id="auth" class="auth">
  <div class="panel card">
    <div class="grid">
      <div class="col">
        <h2 style="margin-top:0">Sign in to <span class="brand">SophosWRLD<span class="dot">.</span></span></h2>
        <p class="muted">A developer hub — collaborate, chat, and share knowledge.</p>
        <div class="row">
          <button class="google" onclick="googleSignIn()"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G"/> Sign in with Google</button>
        </div>
        <div class="row muted">or</div>
        <div class="field">
          <label>Email</label>
          <input id="signInEmail" type="email" placeholder="you@devmail.com"/>
        </div>
        <div class="field">
          <label>Password</label>
          <input id="signInPassword" type="password" placeholder="••••••••"/>
        </div>
        <div class="row">
          <button class="btn" onclick="signIn()">Sign In</button>
          <button class="btn secondary" onclick="toggleAuthMode(true)">Create account</button>
        </div>
        <p id="authError" class="muted"></p>
      </div>
      <div class="col">
        <img src="./images/forum.svg" alt="Forums"/>
      </div>
    </div>
  </div>
</div>

<div id="signup" class="auth hidden">
  <div class="panel card">
    <div class="grid">
      <div class="col">
        <h2 style="margin-top:0">Create your account</h2>
        <div class="field"><label>Display Name</label><input id="signUpName" type="text" maxlength="40" placeholder="Your name"/></div>
        <div class="field"><label>Email</label><input id="signUpEmail" type="email" placeholder="you@devmail.com"/></div>
        <div class="field"><label>Password</label><input id="signUpPassword" type="password" placeholder="Choose a strong password"/></div>
        <div class="row">
          <button class="btn" onclick="signUp()">Create Account</button>
          <button class="btn secondary" onclick="toggleAuthMode(false)">Back to Sign In</button>
        </div>
        <p id="signupError" class="muted"></p>
      </div>
      <div class="col">
        <img src="./images/chat.svg" alt="Chat"/>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div class="topbar">
    <div class="brand">SophosWRLD<span class="dot">.</span></div>
    <div class="tabs">
      <div class="tab active" data-target="home" onclick="nav(this)">Home</div>
      <div class="tab" data-target="chat" onclick="nav(this)">Chat</div>
      <div class="tab" data-target="forums" onclick="nav(this)">Forums</div>
      <div class="tab" data-target="profile" onclick="nav(this)">Profile</div>
    </div>
    <div class="grow"></div>
    <button class="signout" onclick="signOut()">Sign Out</button>
  </div>

  <div class="wrap">
    <!-- HOME -->
    <section id="home" class="section active">
      <div class="card hero">
        <div>
          <h1 style="margin:0 0 6px 0">SophosWRLD — <span class="muted">Developer Communication Hub</span></h1>
          <p class="muted">A place for developers to connect, share ideas, and collaborate on projects. Join discussions, post threads, and chat in real-time — all in one dashboard.</p>
          <div class="row" style="margin-top:8px;">
            <span class="pill">Realtime Chat</span>
            <span class="pill">Forums</span>
            <span class="pill">Profiles</span>
            <span class="pill">Google Login</span>
          </div>
        </div>
        <img src="./images/profile.svg" alt="Profile"/>
      </div>

      <div class="grid" style="margin-top:16px;">
        <div class="card" style="grid-column: span 4;">
          <h3>Chat</h3>
          <p class="muted">Discuss ideas quickly with other devs. Lightweight, real-time.</p>
          <img src="./images/chat.svg" alt="Chat preview"/>
        </div>
        <div class="card" style="grid-column: span 4;">
          <h3>Forums</h3>
          <p class="muted">Long-form topics, announcements, and knowledge sharing.</p>
          <img src="./images/forum.svg" alt="Forum preview"/>
        </div>
        <div class="card" style="grid-column: span 4;">
          <h3>Profile</h3>
          <p class="muted">Customize your presence with name, bio, and avatar.</p>
          <img src="./images/profile.svg" alt="Profile preview"/>
        </div>
      </div>
    </section>

    <!-- CHAT (placeholder) -->
    <section id="chat" class="section">
      <div class="card">
        <h3>Chat</h3>
        <p class="muted">This is a placeholder — wire to your existing rooms/messages collections.</p>
      </div>
    </section>

    <!-- FORUMS -->
    <section id="forums" class="section">
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h3 style="margin:0;">Forums</h3>
          <button class="btn" onclick="toggleNewThread(true)">New Thread</button>
        </div>
        <div id="newThread" class="hidden" style="margin:10px 0;">
          <div class="field"><label>Title</label><input id="threadTitle" type="text" placeholder="Thread title"/></div>
          <div class="field"><label>Body</label><textarea id="threadBody" placeholder="What's on your mind?" style="min-height:120px;"></textarea></div>
          <div class="row">
            <button class="btn" onclick="createThread()">Post Thread</button>
            <button class="btn secondary" onclick="toggleNewThread(false)">Cancel</button>
          </div>
          <p id="threadError" class="muted"></p>
        </div>

        <div id="threads"></div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="section">
      <div class="card">
        <h3>Profile</h3>
        <div class="grid">
          <div class="card" style="grid-column: span 6;">
            <h4>My Info</h4>
            <p><b>Name:</b> <span id="pName"></span></p>
            <p><b>Email:</b> <span id="pEmail"></span></p>
            <p><b>Role:</b> <span id="pRole"></span></p>
            <p><b>UID:</b> <span id="pUid"></span></p>
          </div>
          <div class="card" style="grid-column: span 6;">
            <h4>Edit Profile</h4>
            <div class="field"><label>Display Name</label><input id="editName" type="text" maxlength="40"/></div>
            <div class="field"><label>Bio</label><textarea id="editBio" style="min-height:100px;"></textarea></div>
            <div class="field"><label>Avatar URL</label><input id="editAvatar" type="url"/></div>
            <div class="field"><label>Accent Color</label><input id="editAccent" type="color" value="#e53935"/></div>
            <div class="row">
              <button class="btn" onclick="saveProfile()">Save</button>
            </div>
            <p id="profileMsg" class="muted"></p>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script>
// === CONFIG ===
// Replace with your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCbdfLVFXpRg-wTev7QfPhyJ-LFPpyI3mU",
  authDomain: "sophoswrld.firebaseapp.com",
  databaseURL: "https://sophoswrld-default-rtdb.firebaseio.com",
  projectId: "sophoswrld",
  storageBucket: "sophoswrld.firebasestorage.app",
  messagingSenderId: "26686142400",
  appId: "1:26686142400:web:48f8d3ae0b097731317a25",
  measurementId: "G-6XETC98C22"
};
const APP_ID = "sophoswrld"; // <-- change to your appId used in Firestore paths

// === INIT ===
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

// === UTIL ===
function escapeHTML(s = ''){
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
// Safe element builder
function el(tag, attrs={}, inner=''){
  const e = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){ if (v != null) e.setAttribute(k,v); }
  if (typeof inner === 'string') e.innerHTML = inner;
  else if (inner instanceof Node) e.appendChild(inner);
  else if (Array.isArray(inner)) inner.forEach(n => e.appendChild(n));
  return e;
}
function fmtDate(ts){
  if (!ts) return '';
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return d.toLocaleString();
}

// === AUTH UI TOGGLE ===
function toggleAuthMode(signup){
  document.getElementById('auth').classList.toggle('hidden', signup);
  document.getElementById('signup').classList.toggle('hidden', !signup);
}
function showApp(show){
  document.getElementById('auth').classList.toggle('hidden', true);
  document.getElementById('signup').classList.toggle('hidden', true);
  document.getElementById('app').classList.toggle('hidden', !show);
  if (show) { setActive('home'); }
}

// === NAV ===
function setActive(id){
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  const active = document.querySelector(`.tab[data-target="${id}"]`);
  if (active) active.classList.add('active');
}
function nav(btn){ setActive(btn.dataset.target); }

// === AUTH ACTIONS ===
function signIn(){
  const email = document.getElementById('signInEmail').value.trim();
  const pass  = document.getElementById('signInPassword').value;
  auth.signInWithEmailAndPassword(email, pass).catch(e => {
    document.getElementById('authError').textContent = e.message;
  });
}
function signUp(){
  const name = document.getElementById('signUpName').value.trim();
  const email= document.getElementById('signUpEmail').value.trim();
  const pass = document.getElementById('signUpPassword').value;
  if (!name){ document.getElementById('signupError').textContent = 'Please enter a display name.'; return; }
  auth.createUserWithEmailAndPassword(email, pass).then(async cred => {
    await ensureUserDoc(cred.user.uid, {name});
  }).catch(e => document.getElementById('signupError').textContent = e.message);
}
function googleSignIn(){
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(async result => {
    await ensureUserDoc(result.user.uid, {name: result.user.displayName || 'User'});
  }).catch(e => document.getElementById('authError').textContent = e.message);
}
function signOut(){
  auth.signOut();
}

// Ensure user profile doc exists (aligned with your rules)
async function ensureUserDoc(uid, {name}){
  const ref = db.doc(`artifacts/${APP_ID}/public/data/users/${uid}`);
  const snap = await ref.get();
  if (!snap.exists){
    await ref.set({
      uid,
      name: name || 'User',
      bio: '',
      avatar: '',
      accentColor: '#e53935',
      role: 'member',
      currency: 0,
      isBanned: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  } else {
    // Optionally update name on first login
    if (name && (!snap.data().name || snap.data().name === 'User')){
      await ref.update({ name, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    }
  }
}

// Auth state
let unsubThreads = null;
auth.onAuthStateChanged(async user => {
  if (user){
    showApp(true);
    loadProfile(user);
    watchThreads();
  } else {
    if (unsubThreads) { unsubThreads(); unsubThreads = null; }
    showApp(false);
    document.getElementById('auth').classList.remove('hidden');
  }
});

// === PROFILE ===
async function loadProfile(user){
  document.getElementById('pEmail').textContent = user.email || '';
  document.getElementById('pUid').textContent = user.uid;

  const ref = db.doc(`artifacts/${APP_ID}/public/data/users/${user.uid}`);
  const doc = await ref.get();
  const data = doc.data() || {};
  document.getElementById('pName').textContent = data.name || '';
  document.getElementById('pRole').textContent = data.role || 'member';

  // Fill edit fields
  document.getElementById('editName').value = data.name || '';
  document.getElementById('editBio').value = data.bio || '';
  document.getElementById('editAvatar').value = data.avatar || '';
  document.getElementById('editAccent').value = data.accentColor || '#e53935';
}
async function saveProfile(){
  const user = auth.currentUser;
  if (!user) return;
  const ref = db.doc(`artifacts/${APP_ID}/public/data/users/${user.uid}`);
  const payload = {
    name: document.getElementById('editName').value.trim(),
    bio: document.getElementById('editBio').value,
    avatar: document.getElementById('editAvatar').value,
    accentColor: document.getElementById('editAccent').value,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  try{
    await ref.update(payload);
    document.getElementById('profileMsg').textContent = 'Profile saved.';
    loadProfile(user);
  }catch(e){
    document.getElementById('profileMsg').textContent = e.message;
  }
}

// === FORUMS ===
function toggleNewThread(show){
  document.getElementById('newThread').classList.toggle('hidden', !show);
  if (show) document.getElementById('threadTitle').focus();
}

function renderThread(threadId, data){
  const t = el('div', {class:'thread'});
  const title = escapeHTML(data.title || '');
  const body  = escapeHTML(data.body || '');
  const meta  = `by ${escapeHTML(data.authorId||'unknown')} • ${fmtDate(data.createdAt)}`;
  t.appendChild(el('div',{class:'title'}, title));
  t.appendChild(el('div',{class:'meta'}, meta));
  t.appendChild(el('div',{style:'margin-top:6px;'}, body));

  const postsWrap = el('div', {id:`posts-${threadId}`, style:'margin-top:8px;'});
  t.appendChild(postsWrap);

  // Reply composer
  const comp = el('div', {class:'composer', style:'margin-top:8px;'}, `
    <textarea id="reply-${threadId}" placeholder="Write a reply..."></textarea>
    <div class="row" style="margin-top:6px;">
      <button class="btn" onclick="createReply('${threadId}')">Reply</button>
    </div>
  `);
  t.appendChild(comp);

  // load posts
  loadPosts(threadId, postsWrap);
  return t;
}

async function createThread(){
  const user = auth.currentUser;
  if (!user) return;
  const title = document.getElementById('threadTitle').value.trim();
  const body  = document.getElementById('threadBody').value.trim();
  const errEl = document.getElementById('threadError');
  errEl.textContent='';
  if (!title || !body){ errEl.textContent='Title and body are required.'; return; }
  try{
    await db.collection(`artifacts/${APP_ID}/public/data/forumThreads`).add({
      authorId: user.uid,
      title, body,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('threadTitle').value='';
    document.getElementById('threadBody').value='';
    toggleNewThread(false);
  }catch(e){
    errEl.textContent = e.message;
  }
}

function loadPosts(threadId, wrap){
  db.collection(`artifacts/${APP_ID}/public/data/forumThreads/${threadId}/posts`)
    .orderBy('createdAt','asc')
    .onSnapshot(snap => {
      wrap.innerHTML = '';
      snap.forEach(doc => {
        const d = doc.data();
        const p = el('div', {class:'post'},
          `<div class="muted" style="font-size:12px;">${escapeHTML(d.authorId||'')} • ${fmtDate(d.createdAt)}</div>
           <div>${escapeHTML(d.body||'')}</div>`);
        wrap.appendChild(p);
      });
    });
}

async function createReply(threadId){
  const user = auth.currentUser;
  if (!user) return;
  const ta = document.getElementById(`reply-${threadId}`);
  const text = ta.value.trim();
  if (!text) return;
  try{
    await db.collection(`artifacts/${APP_ID}/public/data/forumThreads/${threadId}/posts`).add({
      authorId: user.uid,
      body: text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    ta.value='';
  }catch(e){
    alert(e.message);
  }
}

function watchThreads(){
  const list = document.getElementById('threads');
  if (window._unsubThreads) { window._unsubThreads(); }
  window._unsubThreads = db.collection(`artifacts/${APP_ID}/public/data/forumThreads`)
    .orderBy('createdAt','desc')
    .onSnapshot(snap => {
      list.innerHTML = '';
      if (snap.empty){
        list.appendChild(el('div', {class:'muted'}, 'No threads yet. Start the first one!'));
      }
      snap.forEach(doc => {
        list.appendChild(renderThread(doc.id, doc.data()));
      });
    });
}
</script>
</body>
</html>
