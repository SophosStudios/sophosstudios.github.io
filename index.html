<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SophosWRLD</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        :root {
            --accent-color: #ef4444; /* Default red accent */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* dark:bg-gray-900 */
        }
        
        /* Custom scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* dark:bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }
        
        /* Left Sidebar: Collapsed by default on desktop, hidden on mobile */
        .left-sidebar {
            width: 72px;
            transition: width 0.3s ease, transform 0.3s ease;
            position: fixed;
            z-index: 40;
            height: 100vh;
            background-color: #1f2937; /* dark:bg-gray-800 */
            flex-shrink: 0;
        }

        /* Sidebar Expanded State */
        .left-sidebar.expanded {
            width: 256px;
        }
        
        /* Main Content Wrapper: Adjusts margin based on sidebar state */
        .main-content-wrapper {
            margin-left: 72px;
            transition: margin-left 0.3s ease;
        }
        .main-content-wrapper.expanded {
            margin-left: 256px;
        }

        /* Mobile specific styles (<= 767px) */
        @media (max-width: 767px) {
            .left-sidebar {
                transform: translateX(-100%);
            }
            .left-sidebar.expanded {
                transform: translateX(0);
            }
            .main-content-wrapper {
                margin-left: 0;
            }
        }
        
        /* Dynamic theme classes based on accent color */
        .accent-red { background-color: var(--accent-color); }
        .accent-red:hover { background-color: var(--accent-color); opacity: 0.8; }
        nav.border-red-500, .border-red-500 { border-color: var(--accent-color); }
        .text-red-500 { color: var(--accent-color); }
        .focus\:ring-red-500:focus { --tw-ring-color: var(--accent-color); }
        .bg-red-600 { background-color: var(--accent-color); }
        .hover\:bg-red-700:hover { background-color: var(--accent-color); opacity: 0.8; }
        .text-red-400 { color: var(--accent-color); opacity: 0.8; }
        
        /* New styling for hover-to-expand buttons */
        .action-btn-group button {
            transition: width 0.3s ease, padding 0.3s ease, background-color 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            width: 40px; /* Initial width for just the icon */
            padding: 8px;
            text-align: center;
        }
        .action-btn-group button:hover {
            width: auto; /* Expand width on hover */
            padding-left: 16px;
            padding-right: 16px;
        }
        .action-btn-group button span {
            display: none;
        }
        .action-btn-group button:hover span {
            display: inline;
        }
        .call-user-btn {
            background-color: #22c55e;
            color: white;
            padding: 10px;
            border-radius: 9999px; /* Tailwind's rounded-full */
            font-size: 1.25rem; /* Tailwind's text-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .call-user-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .call-user-btn:active {
            transform: scale(0.95);
        }
        
        /* WebRTC video container */
        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        #local-video {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            width: 150px;
            height: 112px;
            border-radius: 0.5rem;
            border: 2px solid #fff;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror local video */
            z-index: 10;
        }
        #remote-video {
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
            object-fit: cover;
        }
        .video-call-modal {
            max-width: 90vw;
            max-height: 90vh;
            width: auto;
            height: auto;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div id="modal-container"></div>
    <div id="loading-spinner" class="hidden fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 z-50">
        <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-red-500"></div>
    </div>
    
    <!-- Overlay for mobile sidebar -->
    <div id="overlay-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <!-- Left Sidebar -->
    <aside id="left-sidebar" class="left-sidebar bg-gray-800 text-gray-300 flex flex-col p-4 shadow-xl">
        <div class="flex items-center justify-between h-16 mb-6">
            <!-- Sidebar toggle button -->
            <button id="sidebar-toggle-full" class="hidden md:block text-gray-400 hover:text-white transition-colors duration-200">
                <i class="fas fa-bars"></i>
            </button>
            <!-- Logo in expanded state -->
            <h1 id="website-title-sidebar" class="text-2xl font-bold text-red-500 whitespace-nowrap hidden">SophosWRLD</h1>
            <!-- Logo in collapsed state -->
            <h1 id="website-logo-collapsed" class="text-2xl font-bold text-red-500 whitespace-nowrap md:hidden">SW</h1>
            <!-- Close button for mobile -->
            <button id="sidebar-toggle-close" class="md:hidden text-gray-400 hover:text-white transition-colors duration-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <nav id="left-sidebar-nav" class="space-y-2 flex-grow overflow-y-auto">
            <!-- Nav links will be rendered here -->
        </nav>
        
        <div id="admin-panel-button-container" class="mt-auto pt-4 border-t border-gray-700">
            <!-- Auth/Admin button will be rendered here -->
        </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div id="main-content-wrapper" class="main-content-wrapper min-h-screen">
        <!-- Top Nav for Mobile -->
        <nav class="md:hidden bg-gray-800 text-white p-4 flex items-center justify-between shadow-md">
            <button id="mobile-sidebar-toggle" class="text-gray-400 hover:text-white transition-colors duration-200">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="text-2xl font-bold text-red-500">SophosWRLD</h1>
            <button id="mobile-auth-btn" class="bg-red-600 text-white font-semibold py-1 px-4 rounded-lg hover:bg-red-700 transition duration-300">Account</button>
        </nav>

        <!-- Main Content Area -->
        <main id="content-area" class="p-4 md:p-8 min-h-screen">
            <!-- Page content will be rendered here -->
            <div class="flex flex-col items-center justify-center h-full">
                <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-red-500"></div>
                <p class="mt-4 text-gray-400">Loading...</p>
            </div>
        </main>
    </div>

    <!-- The combined JavaScript logic -->
    <script type="module">
        // =================================================================
        // 1. FIREBASE IMPORTS
        // =================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, updateDoc, deleteDoc, addDoc, query, orderBy, serverTimestamp, where, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // =================================================================
        // 2. CONFIGURATION & GLOBAL VARIABLES
        // =================================================================
        const CONFIG = {
            websiteTitle: "SophosWRLD",
        };

        // --- PLACEHOLDER FOR YOUR FIREBASE CONFIGURATION ---
        const FIREBASE_CONFIG_PLACEHOLDER = {
          apiKey: "AIzaSyCbdfLVFXpRg-wTev7QfPhyJ-LFPpyI3mU",
          authDomain: "sophoswrld.firebaseapp.com",
          databaseURL: "https://sophoswrld-default-rtdb.firebaseio.com",
          projectId: "sophoswrld",
          storageBucket: "sophoswrld.firebasestorage.app",
          messagingSenderId: "26686142400",
          appId: "1:26686142400:web:48f8d3ae0b097731317a25",
          measurementId: "G-6XETC98C22"
        };
        
        // --- DO NOT EDIT BELOW THIS LINE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : FIREBASE_CONFIG_PLACEHOLDER;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Initialize Firebase ---
        let app;
        try {
            app = initializeApp(firebaseConfig);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('content-area').innerHTML = `
                <div class="text-center p-8">
                    <h1 class="text-3xl font-bold text-red-500">Configuration Error</h1>
                    <p class="mt-4 text-gray-400">Please provide a valid Firebase configuration in the code.</p>
                </div>
            `;
            throw error;
        }

        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global state ---
        let appCurrentUser = null;
        let appUserData = null;
        let authReady = false;
        let lastNavigatedPage = null;

        // WebRTC specific globals
        const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };
        let localStream;
        let peerConnection;
        let callUnsubscribe;
        let remoteStream;

        // =================================================================
        // 3. UTILITY FUNCTIONS
        // =================================================================

        /**
         * Shows a loading spinner.
         */
        function showLoadingSpinner() {
            let spinner = document.getElementById('loading-spinner');
            if (spinner) {
                spinner.classList.remove('hidden');
            }
        }

        /**
         * Hides the loading spinner.
         */
        function hideLoadingSpinner() {
            const spinner = document.getElementById('loading-spinner');
            if (spinner) {
                spinner.classList.add('hidden');
            }
        }

        /**
         * Displays a message modal.
         * @param {string} message - The message to display.
         * @param {string} type - 'info', 'error', 'success', or 'confirm'.
         * @param {function} onConfirm - Callback for 'confirm' type.
         */
        function showMessageModal(message, type = 'info', onConfirm = null) {
            const modalContainer = document.getElementById('modal-container');
            const modalId = 'message-modal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full border-2 border-[var(--accent-color)]">
                        <p class="text-lg text-gray-200 mb-4">${message}</p>
                        <div class="flex justify-end space-x-2">
                            ${type === 'confirm' ? `
                                <button id="modal-confirm-btn" class="bg-[var(--accent-color)] text-white px-4 py-2 rounded-lg hover:bg-opacity-80 transition">Yes</button>
                            ` : ''}
                            <button id="modal-close-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">${type === 'confirm' ? 'Cancel' : 'Close'}</button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('modal-close-btn').addEventListener('click', () => document.getElementById(modalId).remove());
            if (type === 'confirm' && onConfirm) {
                document.getElementById('modal-confirm-btn').addEventListener('click', () => {
                    onConfirm();
                    document.getElementById(modalId).remove();
                });
            }
        }
        
        /**
         * Creates and shows a custom modal with dynamic content.
         * @param {string} title - The title of the modal.
         * @param {string} contentHtml - The HTML content for the modal body.
         * @param {string} buttonText - Text for the primary action button.
         * @param {function} onAction - Callback for the primary action button.
         */
        function showCustomModal(title, contentHtml, buttonText = 'Close', onAction = null) {
            const modalContainer = document.getElementById('modal-container');
            const modalId = 'custom-modal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-gray-800 rounded-xl shadow-xl w-full max-w-lg overflow-hidden border-2 border-[var(--accent-color)]">
                        <div class="p-6">
                            <h2 class="text-2xl font-bold text-white mb-4">${title}</h2>
                            <div id="modal-content-body" class="text-gray-300">
                                ${contentHtml}
                            </div>
                        </div>
                        <div class="bg-gray-700 p-4 flex justify-end space-x-2">
                            <button id="modal-action-btn" class="bg-[var(--accent-color)] text-white px-4 py-2 rounded-lg hover:bg-opacity-80 transition">${buttonText}</button>
                            <button id="modal-cancel-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('modal-cancel-btn').addEventListener('click', () => document.getElementById(modalId).remove());
            if (onAction) {
                document.getElementById('modal-action-btn').addEventListener('click', () => {
                    onAction();
                    document.getElementById(modalId).remove();
                });
            } else {
                document.getElementById('modal-action-btn').addEventListener('click', () => document.getElementById(modalId).remove());
            }
        }


        // =================================================================
        // 4. NAVIGATION LOGIC
        // =================================================================
        const leftSidebar = document.getElementById('left-sidebar');
        const leftSidebarNav = document.getElementById('left-sidebar-nav');
        const mainContentWrapper = document.getElementById('main-content-wrapper');
        const contentArea = document.getElementById('content-area');
        const overlayBackdrop = document.getElementById('overlay-backdrop');
        const sidebarToggleDesktop = document.getElementById('sidebar-toggle-full');
        const sidebarToggleMobile = document.getElementById('mobile-sidebar-toggle');
        const sidebarToggleClose = document.getElementById('sidebar-toggle-close');

        function initializeNavigation() {
            if (sidebarToggleDesktop) sidebarToggleDesktop.addEventListener('click', toggleSidebar);
            if (sidebarToggleMobile) sidebarToggleMobile.addEventListener('click', () => {
                leftSidebar.classList.add('expanded');
                overlayBackdrop.classList.remove('hidden');
            });
            if (sidebarToggleClose) sidebarToggleClose.addEventListener('click', () => {
                leftSidebar.classList.remove('expanded');
                overlayBackdrop.classList.add('hidden');
            });
            if (overlayBackdrop) overlayBackdrop.addEventListener('click', () => {
                leftSidebar.classList.remove('expanded');
                overlayBackdrop.classList.add('hidden');
            });
            
            // Set initial state based on window size
            if (window.innerWidth >= 768) {
                leftSidebar.classList.remove('expanded');
                mainContentWrapper.classList.remove('expanded');
            }
        }

        function toggleSidebar() {
            const isExpanded = leftSidebar.classList.toggle('expanded');
            mainContentWrapper.classList.toggle('expanded');

            const navTextElements = leftSidebar.querySelectorAll('.sidebar-nav-text');
            const websiteTitleSidebar = document.getElementById('website-title-sidebar');
            const websiteLogoCollapsed = document.getElementById('website-logo-collapsed');
            const adminButtonContainer = document.getElementById('admin-panel-button-container');

            if (isExpanded) {
                websiteTitleSidebar.classList.remove('hidden');
                websiteLogoCollapsed.classList.add('hidden');
                navTextElements.forEach(el => el.classList.remove('hidden'));
                if (adminButtonContainer.innerHTML.trim() !== '') {
                    adminButtonContainer.classList.remove('hidden');
                }
            } else {
                websiteTitleSidebar.classList.add('hidden');
                websiteLogoCollapsed.classList.remove('hidden');
                navTextElements.forEach(el => el.classList.add('hidden'));
                adminButtonContainer.classList.add('hidden');
            }
        }

        function createNavLink(parentElement, text, page, iconClass) {
            const link = document.createElement('a');
            link.href = '#';
            link.className = `flex items-center space-x-4 py-3 px-4 rounded-xl text-lg font-semibold text-gray-300 hover:bg-gray-700 transition-colors duration-200`;
            link.innerHTML = `
                <i class="${iconClass} text-red-500 w-6 text-center"></i>
                <span class="sidebar-nav-text whitespace-nowrap hidden">${text}</span>
            `;
            link.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo(page);
                if (window.innerWidth < 768) {
                    leftSidebar.classList.remove('expanded');
                    overlayBackdrop.classList.add('hidden');
                }
            });
            parentElement.appendChild(link);
        }

        function renderSidebarNav(currentUser, userData) {
            leftSidebarNav.innerHTML = '';
            
            createNavLink(leftSidebarNav, 'Home', 'home', 'fas fa-home');
            if (currentUser) {
                createNavLink(leftSidebarNav, 'Forums', 'forums', 'fas fa-comments');
                createNavLink(leftSidebarNav, 'Messages', 'messages', 'fas fa-envelope');
                createNavLink(leftSidebarNav, 'Shop', 'shop', 'fas fa-shopping-cart');
                createNavLink(leftSidebarNav, 'Profile', 'profile', 'fas fa-user');
                createNavLink(leftSidebarNav, 'Settings', 'settings', 'fas fa-cog');
            }

            if (userData?.role === 'admin' || userData?.role === 'founder') {
                const adminCategory = document.createElement('div');
                adminCategory.className = 'mt-6 pt-4 border-t border-gray-700';
                leftSidebarNav.appendChild(adminCategory);
                createNavLink(adminCategory, 'Admin Panel', 'admin', 'fas fa-user-shield');
            }

            const authContainer = document.getElementById('admin-panel-button-container');
            authContainer.innerHTML = '';
            
            if (currentUser) {
                const logoutButton = document.createElement('button');
                logoutButton.id = 'logout-btn';
                logoutButton.className = 'w-full py-3 px-4 rounded-lg bg-red-600 text-white font-bold hover:bg-red-700 transition duration-300 text-left flex items-center space-x-4';
                logoutButton.innerHTML = `
                    <i class="fas fa-sign-out-alt w-6 text-center"></i>
                    <span class="sidebar-nav-text whitespace-nowrap hidden">Sign Out</span>
                `;
                logoutButton.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        navigateTo('auth');
                        showMessageModal('You have been signed out.', 'success');
                    } catch (error) {
                        showMessageModal(`Sign out failed: ${error.message}`, 'error');
                    }
                });
                authContainer.appendChild(logoutButton);
                if (leftSidebar.classList.contains('expanded')) {
                    authContainer.classList.remove('hidden');
                } else {
                    authContainer.classList.add('hidden');
                }
            }
        }

        let currentPageId = 'home';
        let unsubscribeFromCalls = null; // Variable to hold the unsubscribe function
        let unsubscribeFromMessages = null;
        let activeCallUnsubscribe = null;

        function navigateTo(pageId, params = {}) {
            if (!authReady) {
                console.log("Auth not ready, delaying navigation.");
                setTimeout(() => navigateTo(pageId, params), 50);
                return;
            }

            if (!appCurrentUser && pageId !== 'home' && pageId !== 'auth') {
                showMessageModal('You must be signed in to access this page.');
                navigateTo('auth');
                return;
            }

            if (appCurrentUser && (appUserData?.role !== 'admin' && appUserData?.role !== 'founder') && pageId === 'admin') {
                 showMessageModal('You do not have permission to view this page.');
                 return;
            }

            // Clean up any active listeners and streams before navigating
            if (callUnsubscribe) callUnsubscribe();
            if (unsubscribeFromMessages) unsubscribeFromMessages();
            if (activeCallUnsubscribe) activeCallUnsubscribe();
            hangUp();
            
            currentPageId = pageId;
            lastNavigatedPage = { pageId, params };
            document.querySelectorAll('#left-sidebar-nav a').forEach(link => {
                link.classList.remove('bg-gray-700');
            });
            const activeLink = document.querySelector(`#left-sidebar-nav a[data-page='${pageId}']`);
            if (activeLink) activeLink.classList.add('bg-gray-700');

            renderPage(pageId, params);
        }

        // =================================================================
        // 5. PAGE RENDERING LOGIC
        // =================================================================
        function renderPage(pageId, params = {}) {
            let pageHtml = '';
            contentArea.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-red-500"></div><p class="mt-4 text-gray-400">Loading...</p></div>`;

            switch (pageId) {
                case 'home':
                    pageHtml = `
                        <div class="flex flex-col items-center justify-center h-full text-center">
                            <h1 class="text-5xl font-extrabold text-red-500 mb-4">Welcome to SophosWRLD!</h1>
                            <p class="text-xl text-gray-400 max-w-2xl">
                                Your digital world for connecting, building, and exploring. Navigate using the sidebar.
                            </p>
                            ${appCurrentUser ? `<p class="mt-4 text-sm text-gray-500">Your User ID: <span class="font-mono text-red-400">${appCurrentUser.uid}</span></p>` : ''}
                        </div>
                    `;
                    contentArea.innerHTML = pageHtml;
                    break;
                case 'profile':
                    showProfilePage(params.userId || appCurrentUser?.uid);
                    break;
                case 'forums':
                    showForumsPage();
                    break;
                case 'messages':
                    showMessagesPage();
                    break;
                case 'settings':
                    showSettingsPage();
                    break;
                case 'shop':
                    showShopPage();
                    break;
                case 'admin':
                    showAdminPanelPage();
                    break;
                case 'auth':
                    showAuthPage();
                    break;
                default:
                    contentArea.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-center">
                            <h1 class="text-5xl font-extrabold text-red-500 mb-4">404</h1>
                            <p class="text-xl text-gray-400">Page Not Found</p>
                        </div>
                    `;
                    break;
            }
        }
        
        function showProfilePage(profileUid) {
            contentArea.innerHTML = `
                <div class="bg-gray-800 rounded-xl shadow-xl p-8 max-w-3xl mx-auto">
                    <h1 class="text-4xl font-bold text-red-500 mb-6">User Profile</h1>
                    <div id="profile-content" class="space-y-4">
                        <p class="text-xl font-semibold">User ID: <span id="profile-uid" class="font-mono text-red-400 text-lg">${profileUid}</span></p>
                        <div id="profile-details-container">
                            <!-- User-specific data will be loaded here -->
                        </div>
                        ${profileUid !== appCurrentUser?.uid ? `
                            <div class="mt-8 flex justify-center space-x-4">
                                <button id="call-user-btn" class="call-user-btn transition duration-300" title="Start a video call">
                                    <i class="fas fa-video"></i>
                                </button>
                                <button id="message-user-btn" class="call-user-btn bg-blue-500 hover:bg-blue-600 transition duration-300" title="Send a message">
                                    <i class="fas fa-comment-dots"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            const callBtn = document.getElementById('call-user-btn');
            if (callBtn) {
                callBtn.addEventListener('click', () => callUser(profileUid));
            }

            const messageBtn = document.getElementById('message-user-btn');
            if (messageBtn) {
                messageBtn.addEventListener('click', () => navigateTo('messages', { recipientId: profileUid }));
            }
            
            // Listen for user data changes
            const userDocRef = doc(db, `artifacts/${appId}/users/${profileUid}/userData`, 'profile');
            onSnapshot(userDocRef, (docSnap) => {
                const profileDetailsContainer = document.getElementById('profile-details-container');
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const userDetailsHtml = `
                        <p class="text-lg">Username: <span class="text-gray-300">${userData.username || 'N/A'}</span></p>
                        <p class="text-lg">Joined: <span class="text-gray-300">${userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleDateString() : 'N/A'}</span></p>
                        <p class="text-lg">Role: <span class="text-gray-300">${userData.role || 'user'}</span></p>
                        <!-- Add more user data fields here -->
                    `;
                    document.getElementById('profile-uid').textContent = profileUid;
                    profileDetailsContainer.innerHTML = userDetailsHtml;
                } else {
                    profileDetailsContainer.innerHTML = `<p>Profile data not found.</p>`;
                }
            });
        }
        
        function showForumsPage() {
            contentArea.innerHTML = `
                <h1 class="text-4xl font-bold text-red-500 mb-6">Forums</h1>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <p class="text-gray-400">This is a placeholder for the forums. You can add topics, posts, and comments here.</p>
                </div>
            `;
        }
        
        // Messaging page rendering
        function showMessagesPage() {
            const recipientId = lastNavigatedPage.params.recipientId || null;
            let currentChatId = null;

            contentArea.innerHTML = `
                <h1 class="text-4xl font-bold text-red-500 mb-6">Messages</h1>
                <div class="flex flex-col md:flex-row bg-gray-800 rounded-xl shadow-lg h-[80vh]">
                    <!-- Conversation List -->
                    <div class="w-full md:w-1/3 border-b md:border-r border-gray-700 p-4 overflow-y-auto" id="conversation-list">
                        <h2 class="text-xl font-semibold mb-4">Conversations</h2>
                        <div id="conversations">
                            <!-- Conversations will be loaded here -->
                        </div>
                    </div>
                    <!-- Chat Window -->
                    <div class="w-full md:w-2/3 p-4 flex flex-col" id="chat-window-container">
                        <div class="flex-grow overflow-y-auto p-2" id="chat-messages">
                            <p class="text-center text-gray-500">Select a conversation or start a new one.</p>
                        </div>
                        <form id="message-form" class="mt-4 flex space-x-2 hidden">
                            <input type="text" id="message-input" class="flex-grow p-2 rounded-lg bg-gray-700 text-white border-none focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Type a message..." autocomplete="off">
                            <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Send</button>
                        </form>
                    </div>
                </div>
            `;
            
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const chatMessages = document.getElementById('chat-messages');

            const sendMessage = async (e) => {
                e.preventDefault();
                const text = messageInput.value.trim();
                if (text && currentChatId) {
                    const messageData = {
                        text,
                        senderId: appCurrentUser.uid,
                        timestamp: serverTimestamp(),
                    };
                    try {
                        const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/conversations/${currentChatId}/messages`);
                        await addDoc(messagesCollectionRef, messageData);
                        messageInput.value = '';
                    } catch (error) {
                        console.error("Error sending message:", error);
                        showMessageModal("Failed to send message.", 'error');
                    }
                }
            };
            messageForm.addEventListener('submit', sendMessage);

            const loadConversation = (chatId) => {
                currentChatId = chatId;
                messageForm.classList.remove('hidden');
                chatMessages.innerHTML = '';
                
                if (unsubscribeFromMessages) unsubscribeFromMessages();

                const messagesQuery = query(collection(db, `artifacts/${appId}/public/data/conversations/${chatId}/messages`), orderBy('timestamp'));
                unsubscribeFromMessages = onSnapshot(messagesQuery, (snapshot) => {
                    chatMessages.innerHTML = ''; // Clear for new messages
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        const isSender = message.senderId === appCurrentUser.uid;
                        const messageClass = isSender ? 'bg-red-600 ml-auto' : 'bg-gray-600';
                        const messageHtml = `
                            <div class="flex items-start mb-4 ${isSender ? 'justify-end' : ''}">
                                <div class="${messageClass} text-white p-3 rounded-lg max-w-xs">
                                    <p>${message.text}</p>
                                </div>
                            </div>
                        `;
                        chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            };

            const loadConversationsList = () => {
                const conversationsRef = collection(db, `artifacts/${appId}/public/data/conversations`);
                const q = query(conversationsRef, where('participants', 'array-contains', appCurrentUser.uid));

                onSnapshot(q, (snapshot) => {
                    const conversationsEl = document.getElementById('conversations');
                    conversationsEl.innerHTML = '';
                    snapshot.forEach(doc => {
                        const convo = doc.data();
                        const otherUserId = convo.participants.find(p => p !== appCurrentUser.uid);
                        const conversationItemHtml = `
                            <div data-chat-id="${doc.id}" class="conversation-item flex items-center p-3 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors duration-200 mb-2">
                                <i class="fas fa-user-circle text-2xl mr-3 text-red-500"></i>
                                <div class="flex-grow">
                                    <p class="text-white font-semibold">User: ${otherUserId}</p>
                                    <!-- Add last message snippet here in the future -->
                                </div>
                            </div>
                        `;
                        conversationsEl.insertAdjacentHTML('beforeend', conversationItemHtml);
                    });

                    document.querySelectorAll('.conversation-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const chatId = item.getAttribute('data-chat-id');
                            loadConversation(chatId);
                        });
                    });
                });
            };

            if (recipientId) {
                 // Try to find an existing conversation
                 const conversationsRef = collection(db, `artifacts/${appId}/public/data/conversations`);
                 const q = query(conversationsRef, where('participants', 'array-contains-any', [appCurrentUser.uid, recipientId]));
                 getDocs(q).then(snapshot => {
                     let existingChatId = null;
                     snapshot.forEach(doc => {
                        const participants = doc.data().participants;
                        if (participants.includes(appCurrentUser.uid) && participants.includes(recipientId)) {
                             existingChatId = doc.id;
                        }
                     });
                     if (existingChatId) {
                         loadConversation(existingChatId);
                     } else {
                         // Create a new conversation if it doesn't exist
                         addDoc(conversationsRef, {
                            participants: [appCurrentUser.uid, recipientId],
                            createdAt: serverTimestamp(),
                         }).then(newChatRef => {
                            loadConversation(newChatRef.id);
                         });
                     }
                 });
            } else {
                loadConversationsList();
            }
        }

        function showSettingsPage() {
            contentArea.innerHTML = `
                <h1 class="text-4xl font-bold text-red-500 mb-6">Settings</h1>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <p class="text-gray-400">This is a placeholder for user settings. Users can change their theme, password, etc., here.</p>
                </div>
            `;
        }

        function showShopPage() {
            contentArea.innerHTML = `
                <h1 class="text-4xl font-bold text-red-500 mb-6">Shop</h1>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <p class="text-gray-400">This is a placeholder for the in-app shop.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
                        <!-- Example Shop Item -->
                        <div class="bg-gray-700 rounded-lg p-4 shadow-md">
                            <h3 class="text-xl font-bold text-red-400">Product A</h3>
                            <p class="text-gray-300 mt-2">A cool virtual item for your profile.</p>
                            <span class="text-lg font-semibold text-white block mt-4">$9.99</span>
                            <button class="w-full mt-4 bg-red-600 text-white font-semibold py-2 rounded-lg hover:bg-red-700 transition">Buy Now</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function showAdminPanelPage() {
            contentArea.innerHTML = `
                <h1 class="text-4xl font-bold text-red-500 mb-6">Admin Panel</h1>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <p class="text-gray-400 mb-4">Manage users and application settings.</p>
                    <h2 class="text-2xl font-semibold mb-4">User Management</h2>
                    <div id="user-list" class="space-y-4">
                        <!-- User list will be loaded here -->
                    </div>
                </div>
            `;

            const userListContainer = document.getElementById('user-list');
            const usersCollectionRef = collection(db, `artifacts/${appId}/users`);
            const q = query(usersCollectionRef);

            onSnapshot(q, (snapshot) => {
                userListContainer.innerHTML = ''; // Clear for new list
                snapshot.forEach(docSnap => {
                    const userId = docSnap.id;
                    const userDataRef = doc(db, `artifacts/${appId}/users/${userId}/userData`, 'profile');
                    getDoc(userDataRef).then(userDoc => {
                        const userData = userDoc.exists() ? userDoc.data() : { username: 'N/A', role: 'user' };
                        const userCardHtml = `
                            <div class="flex items-center justify-between bg-gray-700 p-4 rounded-lg shadow-sm">
                                <div>
                                    <p class="font-bold text-white">${userData.username || 'N/A'}</p>
                                    <p class="text-sm text-gray-400">ID: ${userId}</p>
                                    <p class="text-sm text-gray-400">Role: ${userData.role || 'user'}</p>
                                </div>
                                <button data-user-id="${userId}" class="edit-user-btn bg-red-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-700 transition">
                                    Edit
                                </button>
                            </div>
                        `;
                        userListContainer.insertAdjacentHTML('beforeend', userCardHtml);
                    });
                });
                
                setTimeout(() => {
                    document.querySelectorAll('.edit-user-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const userId = e.target.getAttribute('data-user-id');
                            editUserModal(userId);
                        });
                    });
                }, 500); // Small delay to ensure buttons are rendered
            });
        }
        
        function editUserModal(userId) {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/userData`, 'profile');
            getDoc(userDocRef).then(docSnap => {
                const userData = docSnap.exists() ? docSnap.data() : {};
                const contentHtml = `
                    <form id="edit-user-form" class="space-y-4">
                        <div>
                            <label for="edit-username" class="block text-sm font-medium text-gray-400">Username</label>
                            <input type="text" id="edit-username" class="w-full p-2 mt-1 rounded-lg bg-gray-700 text-white border-gray-600 focus:outline-none focus:ring-2 focus:ring-red-500" value="${userData.username || ''}">
                        </div>
                        <div>
                            <label for="edit-role" class="block text-sm font-medium text-gray-400">Role</label>
                            <select id="edit-role" class="w-full p-2 mt-1 rounded-lg bg-gray-700 text-white border-gray-600 focus:outline-none focus:ring-2 focus:ring-red-500">
                                <option value="user" ${userData.role === 'user' ? 'selected' : ''}>user</option>
                                <option value="admin" ${userData.role === 'admin' ? 'selected' : ''}>admin</option>
                                <option value="founder" ${userData.role === 'founder' ? 'selected' : ''}>founder</option>
                            </select>
                        </div>
                    </form>
                `;
                showCustomModal('Edit User', contentHtml, 'Save Changes', async () => {
                    const newUsername = document.getElementById('edit-username').value;
                    const newRole = document.getElementById('edit-role').value;
                    
                    try {
                        await updateDoc(userDocRef, {
                            username: newUsername,
                            role: newRole,
                        });
                        showMessageModal('User updated successfully!', 'success');
                    } catch (error) {
                        showMessageModal(`Failed to update user: ${error.message}`, 'error');
                    }
                });
            });
        }
        
        function showAuthPage() {
            contentArea.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen -mt-20">
                    <div class="bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-md border-2 border-gray-700">
                        <h2 class="text-3xl font-bold text-center text-white mb-6">Sign In / Sign Up</h2>
                        <form id="auth-form" class="space-y-4">
                            <div>
                                <label for="auth-email" class="sr-only">Email</label>
                                <input type="email" id="auth-email" class="w-full p-3 rounded-lg bg-gray-700 text-white border-gray-600 focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Email" required>
                            </div>
                            <div>
                                <label for="auth-password" class="sr-only">Password</label>
                                <input type="password" id="auth-password" class="w-full p-3 rounded-lg bg-gray-700 text-white border-gray-600 focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Password" required>
                            </div>
                            <button type="submit" id="submit-btn" class="w-full py-3 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 ease-in-out transform hover:scale-105">
                                Sign In
                            </button>
                        </form>
                        <div class="mt-6 text-center">
                            <button id="auth-mode-toggle-btn" class="text-red-400 hover:text-red-300 text-sm transition-colors duration-200">
                                Don't have an account? Sign Up
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const authForm = document.getElementById('auth-form');
            const submitBtn = document.getElementById('submit-btn');
            const authModeToggleBtn = document.getElementById('auth-mode-toggle-btn');
            let isSignUp = false;

            authModeToggleBtn.addEventListener('click', () => {
                isSignUp = !isSignUp;
                submitBtn.textContent = isSignUp ? 'Sign Up' : 'Sign In';
                authModeToggleBtn.textContent = isSignUp ? 'Already have an account? Sign In' : 'Don\'t have an account? Sign Up';
            });

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;

                try {
                    showLoadingSpinner();
                    if (isSignUp) {
                        await createUserWithEmailAndPassword(auth, email, password);
                        showMessageModal("Account created successfully! You are now signed in.", 'success');
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                        showMessageModal("Signed in successfully!", 'success');
                    }
                } catch (error) {
                    console.error("Authentication error:", error);
                    showMessageModal(`Authentication failed: ${error.message}`, 'error');
                } finally {
                    hideLoadingSpinner();
                }
            });
        }
        
        // =================================================================
        // 6. FIRESTORE LOGIC
        // =================================================================
        
        /**
         * Gets or creates user data in Firestore and also checks for a user's role.
         * @param {string} uid - The user's Firebase UID.
         */
        async function getUserData(uid) {
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${uid}/userData`, 'profile');
                const userDocSnap = await getDoc(userDocRef);

                let userData;
                if (userDocSnap.exists()) {
                    userData = userDocSnap.data();
                } else {
                    userData = {
                        createdAt: serverTimestamp(),
                        username: `user_${Math.random().toString(36).substring(2, 9)}`,
                        role: 'user',
                    };
                    await setDoc(userDocRef, userData);
                }
                return userData;
            } catch (error) {
                console.error("Error getting or creating user data:", error);
                return null;
            }
        }
        
        // =================================================================
        // 7. WEBRTC/CALLING LOGIC
        // =================================================================

        /**
         * Initiates a call to a specific user using WebRTC signaling.
         * @param {string} recipientId - The ID of the user to call.
         */
        async function callUser(recipientId) {
            if (!appCurrentUser) {
                showMessageModal("You must be logged in to make a call.");
                return;
            }
            if (appCurrentUser.uid === recipientId) {
                showMessageModal("You cannot call yourself.");
                return;
            }

            try {
                showLoadingSpinner();
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const localVideo = document.getElementById('local-video');
                if (localVideo) localVideo.srcObject = localStream;
                hideLoadingSpinner();
                
                const callModalHtml = `
                    <div class="video-container flex-grow bg-black relative">
                        <video id="remote-video" autoplay playsinline class="w-full h-full"></video>
                        <video id="local-video" autoplay muted playsinline class="rounded-lg shadow-lg absolute bottom-4 right-4 w-36 h-28 border-2 border-white"></video>
                        <div class="absolute bottom-4 left-4 flex space-x-4">
                            <button id="hang-up-btn" class="bg-red-600 text-white p-3 rounded-full hover:bg-red-700 transition">
                                <i class="fas fa-phone-slash"></i>
                            </button>
                        </div>
                    </div>
                `;

                showCustomModal('Calling...', callModalHtml, 'Cancel Call', () => {
                    hangUp();
                });
                
                document.getElementById('hang-up-btn').addEventListener('click', hangUp);
                
                peerConnection = new RTCPeerConnection(servers);
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                peerConnection.ontrack = (event) => {
                    const remoteVideo = document.getElementById('remote-video');
                    remoteStream = event.streams[0];
                    if (remoteVideo) remoteVideo.srcObject = remoteStream;
                };

                const callDocRef = doc(collection(db, `artifacts/${appId}/public/data/calls`), recipientId);
                const offerCandidates = collection(callDocRef, 'offerCandidates');
                const answerCandidates = collection(callDocRef, 'answerCandidates');
                
                peerConnection.onicecandidate = (event) => {
                    event.candidate && addDoc(offerCandidates, event.candidate.toJSON());
                };

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                await setDoc(callDocRef, {
                    callerId: appCurrentUser.uid,
                    recipientId: recipientId,
                    offer: {
                        type: offer.type,
                        sdp: offer.sdp
                    }
                });

                callUnsubscribe = onSnapshot(callDocRef, (docSnap) => {
                    const data = docSnap.data();
                    if (!peerConnection.currentRemoteDescription && data?.answer) {
                        peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                });
                
                onSnapshot(answerCandidates, (snapshot) => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const candidate = new RTCIceCandidate(change.doc.data());
                            peerConnection.addIceCandidate(candidate);
                        }
                    });
                });
            } catch (error) {
                console.error("Error calling user:", error);
                showMessageModal(`Failed to initiate call: ${error.message}`, 'error');
                hangUp();
            }
        }
        
        /**
         * Handles an incoming call notification.
         * @param {Object} callData - The data of the incoming call.
         */
        async function handleIncomingCall(callData) {
            showMessageModal(`Incoming call from user ${callData.callerId}. Do you want to accept?`, 'confirm', async () => {
                try {
                    showLoadingSpinner();
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    const callModalHtml = `
                        <div class="video-container flex-grow bg-black relative">
                            <video id="remote-video" autoplay playsinline class="w-full h-full"></video>
                            <video id="local-video" autoplay muted playsinline class="rounded-lg shadow-lg absolute bottom-4 right-4 w-36 h-28 border-2 border-white"></video>
                            <div class="absolute bottom-4 left-4 flex space-x-4">
                                <button id="hang-up-btn" class="bg-red-600 text-white p-3 rounded-full hover:bg-red-700 transition">
                                    <i class="fas fa-phone-slash"></i>
                                </button>
                            </div>
                        </div>
                    `;

                    showCustomModal('Connected', callModalHtml, 'End Call', () => {
                         hangUp();
                    });
                    document.getElementById('hang-up-btn').addEventListener('click', hangUp);

                    const localVideo = document.getElementById('local-video');
                    localVideo.srcObject = localStream;
                    hideLoadingSpinner();
                    
                    peerConnection = new RTCPeerConnection(servers);
                    localStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, localStream);
                    });

                    peerConnection.ontrack = (event) => {
                        remoteStream = event.streams[0];
                        const remoteVideo = document.getElementById('remote-video');
                        if (remoteVideo) remoteVideo.srcObject = remoteStream;
                    };

                    peerConnection.onicecandidate = (event) => {
                        event.candidate && addDoc(collection(db, `artifacts/${appId}/public/data/calls/${appCurrentUser.uid}/answerCandidates`), event.candidate.toJSON());
                    };
                    
                    const offer = callData.offer;
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    const callDocRef = doc(db, `artifacts/${appId}/public/data/calls`, appCurrentUser.uid);
                    await updateDoc(callDocRef, {
                        answer: {
                            type: answer.type,
                            sdp: answer.sdp
                        }
                    });
                    
                    onSnapshot(collection(db, `artifacts/${appId}/public/data/calls/${appCurrentUser.uid}/offerCandidates`), (snapshot) => {
                         snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                const candidate = new RTCIceCandidate(change.doc.data());
                                peerConnection.addIceCandidate(candidate);
                            }
                         });
                    });
                    
                } catch (error) {
                    console.error("Error accepting call:", error);
                    showMessageModal("Failed to accept call. Please try again.", 'error');
                    hangUp();
                }
            });
        }
        
        /**
         * Cleans up the call and closes the modal.
         */
        function hangUp() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            const modal = document.getElementById('custom-modal');
            if (modal) modal.remove();
        }

        /**
         * Listens for incoming WebRTC call offers from other users.
         * @param {string} uid - The user's Firebase UID.
         */
        function listenForCalls(uid) {
            const callDocRef = doc(db, `artifacts/${appId}/public/data/calls`, uid);
            if (callUnsubscribe) callUnsubscribe();
            
            callUnsubscribe = onSnapshot(callDocRef, (docSnap) => {
                 if (docSnap.exists()) {
                     const callData = docSnap.data();
                     if (callData.offer && callData.callerId !== uid) {
                         handleIncomingCall(callData);
                     }
                 }
            });
        }
        
        // =================================================================
        // 8. INITIALIZATION & EVENT LISTENERS
        // =================================================================
        
        // Firebase Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            showLoadingSpinner();
            appCurrentUser = user;
            
            if (user) {
                appUserData = await getUserData(user.uid);
                
                renderSidebarNav(appCurrentUser, appUserData);
                
                if (lastNavigatedPage) {
                    navigateTo(lastNavigatedPage.pageId, lastNavigatedPage.params);
                } else {
                    navigateTo('home');
                }
                
                listenForCalls(user.uid);
            } else {
                appUserData = null;
                
                renderSidebarNav(appCurrentUser, appUserData);
                
                if (currentPageId !== 'auth') {
                    navigateTo('auth');
                } else {
                    navigateTo('auth');
                }
            }
            authReady = true;
            hideLoadingSpinner();
        });

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', async () => {
            initializeNavigation();
            
            if (initialAuthToken) {
                try {
                     await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                     console.error("Error signing in with custom token:", error);
                     navigateTo('auth');
                }
            } else {
                 if (!appCurrentUser) navigateTo('auth');
            }
            
            const mobileAuthBtn = document.getElementById('mobile-auth-btn');
            if (mobileAuthBtn) {
                mobileAuthBtn.addEventListener('click', () => {
                    if (appCurrentUser) {
                        navigateTo('profile');
                    } else {
                        navigateTo('auth');
                    }
                });
            }
        });
    </script>
</body>
</html>
